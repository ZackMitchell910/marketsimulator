<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scenario Playground</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

    :root {
      color-scheme: dark;
      --bg: #000000;
      --fg: #ffffff;
      --muted-70: rgba(255, 255, 255, 0.70);
      --muted-60: rgba(255, 255, 255, 0.60);
      --muted-50: rgba(255, 255, 255, 0.50);
      --surface: rgba(255, 255, 255, 0.05);
      --surface-weak: rgba(255, 255, 255, 0.03);
      --border: rgba(255, 255, 255, 0.10);
      --border-strong: rgba(255, 255, 255, 0.18);
      --accent: #9ffcff;
      --accent-soft: rgba(159, 252, 255, 0.14);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      min-height: 100%;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--fg);
    }

    ::selection { background: rgba(255, 255, 255, 0.2); color: #000; }

    a { color: inherit; text-decoration: none; }

    .noise-overlay::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      mix-blend-mode: screen;
      opacity: 0.05;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="180" height="180"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.35"/></svg>');
    }

    .grid-overlay::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        linear-gradient(to right, rgba(255,255,255,0.12) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,0.12) 1px, transparent 1px);
      background-size: 48px 48px;
      opacity: 0.08;
      mask-image: radial-gradient(ellipse at top, black 0%, transparent 70%);
      -webkit-mask-image: radial-gradient(ellipse at top, black 0%, transparent 70%);
    }

    .navbar {
      position: sticky;
      top: 0;
      z-index: 40;
      border-bottom: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(12px);
    }

    .navbar-inner {
      max-width: 74rem;
      margin: 0 auto;
      padding: 0 20px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      font-size: 11px;
      letter-spacing: 0.06em;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand-title {
      font-weight: 600;
      font-size: 13px;
      letter-spacing: 0.12em;
    }

    .brand-subtitle {
      font-size: 10px;
      color: var(--muted-60);
      letter-spacing: 0.24em;
      text-transform: uppercase;
    }

    .navbar-links {
      display: flex;
      gap: 14px;
      color: var(--muted-60);
    }

    .navbar-links a {
      position: relative;
      padding: 4px 8px;
      border-radius: 10px;
      transition: color 150ms ease;
    }

    .navbar-links a:hover {
      color: var(--fg);
    }

    .navbar-links a::after {
      content: "";
      position: absolute;
      inset: -6px;
      border-radius: 16px;
      opacity: 0;
      background: radial-gradient(120px 120px at 50% 50%, rgba(255,255,255,0.18), transparent 60%);
      transition: opacity 200ms ease;
      z-index: -1;
    }

    .navbar-links a:hover::after {
      opacity: 1;
    }

    .cta-group {
      display: flex;
      gap: 10px;
    }

    .btn-outline, .btn-ghost {
      border-radius: 0.7rem;
      padding: 0.55rem 1rem;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: background 180ms ease, border-color 180ms ease;
    }

    .btn-outline {
      border: 1px solid var(--border-strong);
      background: transparent;
      color: var(--muted-70);
    }

    .btn-outline:hover {
      background: rgba(255,255,255,0.12);
      color: var(--fg);
    }

    .btn-ghost {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.08);
      color: var(--fg);
    }

    main {
      max-width: 74rem;
      margin: 0 auto;
      padding: 36px clamp(18px, 3.5vw, 40px) 56px;
    }

    .hero {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 28px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted-60);
    }

    h1 {
      margin: 0;
      font-size: clamp(24px, 4vw, 34px);
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .subtitle {
      max-width: 720px;
      font-size: 14px;
      color: var(--muted-60);
      line-height: 1.6;
    }

    .workspace {
      display: grid;
      gap: 22px;
    }

    @media (min-width: 1080px) {
      .workspace {
        grid-template-columns: 330px minmax(0, 1fr);
        align-items: start;
      }
    }

    .card {
      position: relative;
      border-radius: 0.9rem;
      border: 1px solid var(--border);
      background: var(--surface);
      padding: clamp(18px, 2.5vw, 26px);
      overflow: hidden;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(135deg, rgba(159,252,255,0.12), transparent 65%);
    }

    label {
      display: block;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted-50);
      margin-bottom: 12px;
    }

    textarea {
      width: 100%;
      min-height: 130px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.65);
      color: var(--fg);
      font-size: 15px;
      line-height: 1.6;
      resize: vertical;
      transition: border-color 150ms ease, box-shadow 150ms ease;
    }

    textarea:focus {
      outline: none;
      border-color: var(--border-strong);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .controls {
      display: flex;
      gap: 14px;
      margin-top: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .status {
      font-size: 12px;
      color: var(--muted-60);
      min-height: 20px;
    }

    .btn-run {
      border-radius: 0.75rem;
      padding: 0.7rem 1.3rem;
      border: 1px solid var(--border-strong);
      background: rgba(255,255,255,0.12);
      color: var(--fg);
      font-size: 11px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      transition: background 160ms ease, border-color 160ms ease, transform 160ms ease;
    }

    .btn-run:hover:not(:disabled),
    .btn-run:focus-visible {
      background: rgba(255,255,255,0.18);
      border-color: rgba(255,255,255,0.28);
      transform: translateY(-1px);
    }

    .btn-run:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      border-radius: 0.6rem;
      padding: 0.45rem 1.05rem;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.08);
      color: var(--fg);
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 150ms ease, border-color 150ms ease, transform 150ms ease;
    }

    .btn-secondary:hover,
    .btn-secondary:focus-visible {
      background: rgba(255,255,255,0.14);
      border-color: rgba(255,255,255,0.24);
      transform: translateY(-1px);
    }

    .event-card {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .event-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .event-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .event-controls input {
      width: 118px;
      padding: 0.45rem 0.75rem;
      border-radius: 0.6rem;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.6);
      color: var(--fg);
      font-size: 13px;
    }

    .event-controls input:focus {
      outline: none;
      border-color: rgba(159,252,255,0.5);
      box-shadow: 0 0 0 1px rgba(159,252,255,0.35);
    }

    .event-log {
      margin: 0;
      padding: 14px;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.55);
      max-height: 260px;
      overflow: auto;
      font-family: "IBM Plex Mono", "SFMono-Regular", Consolas, monospace;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .results-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      margin-top: 16px;
    }

    .placeholder {
      color: var(--muted-60);
      margin: 0;
    }

    .impact-card {
      position: relative;
      border-radius: 0.9rem;
      border: 1px solid var(--border);
      background: var(--surface-weak);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .impact-card::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(160deg, rgba(159,252,255,0.16), transparent 75%);
    }

    .impact-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .impact-ticker {
      font-size: 19px;
      font-weight: 600;
      letter-spacing: 0.07em;
    }

    .score-chip {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted-60);
    }

    .metrics {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }

    .metric {
      flex: 1;
      min-width: 110px;
      border-radius: 0.7rem;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.55);
      padding: 10px 12px;
    }

    .metric-label {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted-50);
    }

    .metric-value {
      margin-top: 4px;
      font-size: 16px;
      font-weight: 600;
      color: var(--fg);
    }

    .metric-value.positive { color: #8ff7e0; }
    .metric-value.negative { color: #ff93a5; }

    .orders {
      border-radius: 0.7rem;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.6);
      padding: 12px;
    }

    .orders-title {
      margin: 0 0 10px;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted-50);
    }

    .orders table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .orders th,
    .orders td {
      text-align: left;
      padding: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .orders th {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--muted-60);
    }

    .projection-preview {
      padding: 10px;
      border-radius: 0.7rem;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.6);
      font-family: "Consolas", "Courier New", monospace;
      font-size: 11px;
      line-height: 1.5;
      color: rgba(220, 220, 220, 0.88);
      max-height: 160px;
      overflow: auto;
      white-space: pre-wrap;
    }

    footer {
      margin-top: 36px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      color: var(--muted-60);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
  </style>
</head>
<body>
  <div class="noise-overlay">
    <div class="grid-overlay">
      <header class="navbar">
        <div class="navbar-inner">
          <div class="brand">
            <span class="brand-title">MARKET SIMULATOR</span>
            <span class="brand-subtitle">CONTROL ROOM</span>
          </div>
          <nav class="navbar-links">
            <a href="#scenario-input">Scenario</a>
            <a href="#impacts">Impacts</a>
            <a href="/dashboard">Dashboard</a>
          </nav>
          <div class="cta-group">
            <a class="btn-outline" href="/reports">Reports</a>
            <a class="btn-ghost" href="/dashboard">Live View</a>
          </div>
        </div>
      </header>

      <main>
        <section class="hero">
          <span class="badge">Scenario Ops</span>
          <h1>Stress the market twin with headline-driven simulations.</h1>
          <p class="subtitle">
            Describe the shock, observe the personas, and review the top three exposures alongside projected candles and agent orders. Everything runs inside the control loop—no waiting, no guesswork.
          </p>
        </section>

        <section class="workspace">
          <article class="card" id="scenario-input">
            <label for="scenarioText">Scenario brief</label>
            <textarea id="scenarioText" placeholder="For example: What happens if NVIDIA misses earnings?"></textarea>
            <div class="controls">
              <div class="status" id="status"></div>
              <button id="runBtn" class="btn-run">Run Simulation</button>
            </div>
          </article>

          <article class="card" id="impacts">
            <label>Top impacts</label>
            <div id="results" class="results-grid">
              <p class="placeholder">Projected impacts will appear here after you run a scenario.</p>
            </div>
          </article>

          <article class="card event-card" id="live-events">
            <div class="event-header">
              <label for="runIdInput">Live events</label>
              <div class="event-controls">
                <input id="runIdInput" type="text" value="demo" aria-label="Run identifier" />
                <button id="eventConnectBtn" class="btn-secondary">Connect</button>
              </div>
            </div>
            <pre id="eventLog" class="event-log">Connect to a run to see streaming events.</pre>
          </article>
        </section>

        <footer>
          Market Simulator &mdash; synthetic market twin &bull; persona coordination &bull; future path projections
        </footer>
      </main>
    </div>
  </div>

  <script>
  const runBtn = document.getElementById("runBtn");
  const textArea = document.getElementById("scenarioText");
  const results = document.getElementById("results");
  const status = document.getElementById("status");
  const runIdInput = document.getElementById("runIdInput");
  const eventConnectBtn = document.getElementById("eventConnectBtn");
  const eventLog = document.getElementById("eventLog");

  let eventSource = null;
  let reconnectTimer = null;
  const eventLogLines = [];

  function renderResults(data) {
    results.innerHTML = "";

    if (!data.impacts || !data.impacts.length) {
      results.innerHTML = '<p class="placeholder">No impacted tickers surfaced. Refine the scenario and try again.</p>';
      return;
    }

    data.impacts.forEach((impact) => {
      const series = Array.isArray(impact.projection) ? impact.projection : [];
      const firstBar = series[0] || {};
      const lastBar = series[series.length - 1] || {};
      const open = Number(firstBar.open || 0);
      const close = Number(lastBar.close || 0);
      const delta = close - open;
      const pct = open ? (delta / open) * 100 : 0;
      const directionClass = delta >= 0 ? "positive" : "negative";
      const directionGlyph = delta >= 0 ? "+" : "-";

      const container = document.createElement("div");
      container.className = "impact-card";
      container.innerHTML = `
        <div class="impact-header">
          <span class="impact-ticker">${impact.ticker}</span>
          <span class="score-chip">Score ${impact.score.toFixed(2)}</span>
        </div>
        <div class="metrics">
          <div class="metric">
            <div class="metric-label">Projected Bars</div>
            <div class="metric-value">${series.length}</div>
          </div>
          <div class="metric">
            <div class="metric-label">Net Move</div>
            <div class="metric-value ${directionClass}">${directionGlyph}${Math.abs(delta).toFixed(2)}</div>
          </div>
          <div class="metric">
            <div class="metric-label">Net Percent</div>
            <div class="metric-value ${directionClass}">${directionGlyph}${Math.abs(pct).toFixed(2)}%</div>
          </div>
        </div>
      `;

      if (impact.orders && impact.orders.length) {
        const ordersDiv = document.createElement("div");
        ordersDiv.className = "orders";
        const rows = impact.orders.map((order) => `
          <tr>
            <td>${order.agent_id}</td>
            <td>${order.side}</td>
            <td>${order.qty.toFixed(2)}</td>
            <td>${order.price_limit ? order.price_limit.toFixed(2) : "-"}</td>
          </tr>
        `).join("");
        ordersDiv.innerHTML = `
          <h3 class="orders-title">Agent Orders</h3>
          <table>
            <thead><tr><th>Agent</th><th>Side</th><th>Qty</th><th>Limit</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
        container.appendChild(ordersDiv);
      }

      const preview = document.createElement("div");
      preview.className = "projection-preview";
      const previewSlice = series.slice(0, 8);
      preview.textContent = JSON.stringify(previewSlice, null, 2) + (series.length > previewSlice.length ? "\n..." : "");
      container.appendChild(preview);

      results.appendChild(container);
    });
  }

  function formatNumber(value, digits = 2) {
    const num = Number(value);
    return Number.isFinite(num) ? num.toFixed(digits) : String(value ?? "");
  }

  function summarizeEvent(event) {
    if (!event || typeof event !== "object") {
      return "event " + String(event);
    }
    const type = (event.type || "event").toString().toUpperCase();
    if (event.type === "tick") {
      return `${type} ${event.symbol ?? ""} @ ${formatNumber(event.price)}`;
    }
    if (event.type === "order") {
      return `${type} ${event.side ?? ""} ${event.symbol ?? ""} qty ${formatNumber(event.qty)} limit ${formatNumber(event.limit ?? event.price)}`;
    }
    if (event.type === "trade") {
      return `${type} ${event.symbol ?? ""} qty ${formatNumber(event.qty)} @ ${formatNumber(event.price)}`;
    }
    if (event.type === "position") {
      return `${type} ${event.symbol ?? ""} qty ${formatNumber(event.qty)} pnl ${formatNumber(event.pnl)}`;
    }
    return `${type} ${JSON.stringify(event)}`;
  }

  function appendEventLine(message) {
    if (!eventLog) {
      return;
    }
    const timestamp = new Date().toLocaleTimeString();
    eventLogLines.push(`${timestamp} ${message}`);
    if (eventLogLines.length > 60) {
      eventLogLines.shift();
    }
    eventLog.textContent = eventLogLines.join("\n");
    eventLog.scrollTop = eventLog.scrollHeight;
  }

  function connectEventStream(runId) {
    if (!eventLog) {
      return;
    }
    const target = runId && runId.trim() ? runId.trim() : "demo";
    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }
    if (reconnectTimer) {
      clearTimeout(reconnectTimer);
      reconnectTimer = null;
    }
    eventLogLines.length = 0;
    appendEventLine(`subscribing to run ${target}`);
    eventSource = new EventSource(`/events?run_id=${encodeURIComponent(target)}`);
    eventSource.onopen = () => appendEventLine("stream connected");
    eventSource.onmessage = (evt) => {
      try {
        const data = JSON.parse(evt.data);
        appendEventLine(summarizeEvent(data));
      } catch (error) {
        appendEventLine("received unparseable event");
      }
    };
    eventSource.onerror = () => {
      appendEventLine("stream interrupted, retrying…");
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      reconnectTimer = setTimeout(() => connectEventStream(target), 3000);
    };
  }

  async function runScenario() {
    const text = textArea.value.trim();
    if (!text) {
      status.textContent = "Please describe a scenario first.";
      return;
    }

    runBtn.disabled = true;
    status.textContent = "Simulating...";
    results.innerHTML = "";

    try {
      const res = await fetch("/scenario", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, steps: 30 })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Scenario failed");
      }

      const payload = await res.json();
      status.textContent = \`Generated at \${payload.generated_at}\`;
      renderResults(payload);
    } catch (err) {
      console.error(err);
      status.textContent = err.message;
    } finally {
      runBtn.disabled = false;
    }
  }

  runBtn.addEventListener("click", runScenario);
  textArea.addEventListener("keydown", (evt) => {
    if (evt.ctrlKey && evt.key === "Enter") {
      runScenario();
    }
  });

  if (eventConnectBtn && runIdInput) {
    eventConnectBtn.addEventListener("click", () => {
      connectEventStream(runIdInput.value || "demo");
    });
    runIdInput.addEventListener("keydown", (evt) => {
      if (evt.key === "Enter") {
        evt.preventDefault();
        connectEventStream(runIdInput.value || "demo");
      }
    });
    connectEventStream(runIdInput.value || "demo");
  }

  window.addEventListener("beforeunload", () => {
    if (eventSource) {
      eventSource.close();
    }
    if (reconnectTimer) {
      clearTimeout(reconnectTimer);
    }
  });
  </script>
</body>
</html>
